<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Proses WH</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <style>
      /* Custom Checkbox Utama */
      .custom-checkbox {
        appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid red;
        border-radius: 4px;
        position: relative;
        cursor: pointer;
        background-color: white;
        transition: background 0.2s, border 0.2s;
      }

      /* Checked state */
      .custom-checkbox:checked {
        background-color: red;
        border-color: red;
      }

      /* Tanda âœ• saat checked */
      .custom-checkbox:checked::after {
        content: "âœ•";
        color: white;
        font-size: 14px;
        font-weight: bold;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none; /* agar tidak mengganggu klik */
      }

      /* Disabled state */
      .custom-checkbox:disabled {
        background-color: #fc7979; /* merah pucat */
        border-color: #fc7979;
        cursor: not-allowed;
      }

      /* Disabled + Checked */
      .custom-checkbox:disabled:checked::after {
        content: "âœ•";
        color: #fff5f5; /* putih pucat */
      }
    </style>
    <style>
      /* Tooltip simple berbasis data-tooltip */
      [data-tooltip] {
        position: relative;
        cursor: pointer;
      }
      [data-tooltip]::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%; /* posisi di atas elemen */
        left: 50%;
        transform: translateX(-50%);
        background-color: #1f2937; /* bg-gray-800 */
        color: white;
        padding: 4px 8px;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
      }
      [data-tooltip]:hover::after {
        opacity: 1;
      }

      /* Transisi smooth untuk opacity */
      #alertModal {
        transition: opacity 0.3s ease;
      }
    </style>

    <style>
    .thin-scroll::-webkit-scrollbar {
      width: 3px;
      height: 3px;
    }
    .thin-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.4);
      border-radius: 2px;
    }
    .thin-scroll::-webkit-scrollbar-track {
      background: transparent;
    }
    </style>


<style>
  @keyframes shakeOpacity {
    0%, 100% { opacity: 1; }
    25%, 75% { opacity: 0.85; }
    50% { opacity: 0.7; }
  }

  .shake {
    animation: shakeOpacity 0.4s ease-in-out;
  }
</style>

  </head>
 <body class="h-screen flex">

<div id="alertModal" 
     class="hidden fixed top-4 left-1/2 -translate-x-1/2 
            bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg 
            flex items-center justify-between gap-3 z-50 text-4xl">
  <span id="alertMessage"></span>
  <button id="alertBtn" class="shadow shadow-sm shadow-red-300 p-2 bg-red-600 border border-red-700 rounded-xl text-white hover:shadow-none hover:text-gray-200">
    <i class="bi bi-x-lg"></i>
  </button>
</div>


    <!-- Sidebar kiri -->
    <!-- Pastikan sudah load Bootstrap Icons CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">



    <div id="sidebar" class="w-[27%] min-[1920px]:w-[20%] p-2 border-r border-gray-300 flex flex-col">

      <!-- Wrapper Tanggal -->
      <div class="mb-3">
        <input id="tanggalInput"
              type="date"
              class="w-full border border-gray-300 rounded-md px-3 py-1 text-sm h-[38px] focus:outline-none focus:ring-1 focus:ring-blue-400">
      </div>

      <!-- Header Sidebar -->
      <h2 id="sidebarHeader" class="text-xl font-semibold mb-2 flex-shrink-0 border-b border-gray-300 pb-2 flex items-center w-full gap-2">
        <!-- Tombol Power -->
        <button class="px-3 py-1 border border-gray-300 rounded-md bg-white hover:bg-gray-100 flex items-center justify-center" title="Power">
          <i class="bi bi-power text-red-500 text-lg"></i>
        </button>

        <!-- Kolom Search -->
        <input id="cariDataSj"
              type="search"
              class="flex-1 border border-gray-300 rounded-md px-3 py-1 text-sm h-[38px] focus:outline-none focus:ring-1 focus:ring-blue-400"
              placeholder="Cari SJ...">
      </h2>
      
      <!-- Header Sidebar -->
      <h2 id="sidebarHeader" class="text-xl font-semibold mb-4 flex-shrink-0 border-b border-gray-300 pb-2 w-full grid grid-cols-4 gap-1">
        
        <!-- Menampung seluruh jumlah transaksi -->
        <div class="flex items-center gap-2 border rounded-md p-1">
          <i class="bi bi-graph-up-arrow text-red-500 text-lg"></i>
          <span id="col1Text" class="text-sm"></span>
        </div>

        <!-- Menampung jumlah transaksi Online / Offline -->
        <div class="flex items-center gap-2 border rounded-md p-1">
          <i class="bi bi-toggles2 text-gray-500 text-lg"></i>
          <span id="col2Text" class="text-sm"></span>
        </div>

        <!-- Menampung jumlah transaksi yang menggunakan ekspedisi -->
        <div class="flex items-center gap-2 border rounded-md p-1">
          <i class="bi bi-truck text-blue-500 text-lg"></i>
          <span id="col3Text" class="text-sm"></span>
        </div>

        <!-- Menampung jumlah transaksi yang melibatkan retur -->
        <div class="flex items-center gap-2 border rounded-md p-1">
          <i class="bi bi-recycle text-yellow-500 text-lg"></i>
          <span id="col3Text" class="text-sm"></span>
        </div>

      </h2>


      <!-- Isi Summary -->
      <div id="summary" class="space-y-2 flex-1 overflow-auto thin-scroll">
        <!-- isi summary -->
      </div>
    </div>


    <!-- Konten kanan -->
    <div id="mainContent" class="flex-1 p-4 overflow-auto">
      <h2 class="text-xl font-semibold mb-4">Detail Items</h2>
      <div id="detail"></div>
    </div>


<!-- Modal -->
<div id="layer-2-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-2xl shadow-lg w-11/12 max-w-4xl relative">
    <!-- Tombol Close -->
    <button id="close-layer-2" class="absolute top-2 right-2 text-gray-600 hover:text-black text-xl">
      âœ•
    </button>
    <h2 class="text-xl font-bold mb-4">Tambahkan Stock Lain</h2>
    <div id="modal-content-layer-2" class="text-gray-700">
      <!-- Konten akan diisi lewat JS -->
      <div class="list-stock max-h-[500px] overflow-y-auto"></div>
    </div>
    <div class="mt-4 text-right">
      <button id="close-btn-layer-2" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
        Tutup
      </button>
    </div>
  </div>
</div>


    <!-- Libraries -->
    <!-- <script src="https://unpkg.com/lucide@latest"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.10.0/dist/axios.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/diarmacpro/cdnku@4849b7e3a19e88b14d27454f60d16c062e16648d/core.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/diarmacpro/cdnku@35e5003dbb8177b966f240b861c2bb547fc7f013/firebase-olah-data/f.o.d_v.0.2.js" crossorigin="anonymous"></script>

    <script src="./script.js"></script>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
      import { getDatabase, ref, set, get, update, push, query, remove, orderByChild, equalTo, onValue, off } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js';
      const app = initializeApp({ databaseURL: "https://stock-wv-default-rtdb.asia-southeast1.firebasedatabase.app" });
      const db = getDatabase(app);

      const app2 = initializeApp({ databaseURL: "https://stk-wv-default-rtdb.asia-southeast1.firebasedatabase.app" },"app2");
      const db2 = getDatabase(app2);

      Object.assign(window, { db, db2, ref, set, get, update, push, query, remove, orderByChild, equalTo, onValue, off });
    </script>

<script>
  var data = {};
  var tempData = {};
  let fbsSvc,fbsSvcX;

  // Cari data marketing by ID
  function cariById(id) {
    return data.nmMkt.find(item => item.id_mkt === String(id)) || null;
  }

  function nmHlp(id) {
    return data.helper.find(item => item.id_hlp === id) || null;
  }

  // Fungsi filter berdasarkan input
  function filterSummary(keyword) {
    keyword = String(keyword || "").toLowerCase().trim();

    if (!keyword) return Object.values(data.dataside || {});

    return Object.values(data.dataside || {}).filter(item =>
      String(item.id_sj).toLowerCase().includes(keyword) ||
      String(item.id_mkt).toLowerCase().includes(keyword) ||
      String(item.jml_item).toLowerCase().includes(keyword) ||
      String(item.mkt || "").toLowerCase().includes(keyword) ||
      String(item.stamp || "").toLowerCase().includes(keyword)
    );
  }

  // Render awal atau setelah filter
  function renderFiltered(keyword) {
    const filtered = filterSummary(keyword);
    renderElemenSummary(filtered);
  }

  // Load data SJ sesuai tanggal
  function loadDataSJ(tgl) {
    prosesDataSJ(
      'https://cdn.weva.my.id/apix/dtSj',
      { tgl },
      (result) => {
        data.result = result;
        data.dataside = data.result.summary;
        renderElemenSummary(data.dataside);
      }
    );
  }

  function cariByIdSj(idSj) {
    const targetId = Number(idSj); // pastikan jadi number agar presisi
    return data.result.raw.filter(item => Number(item.id_sj) === targetId);
  }

  function getDtStock(id, callback) {
    fbsSvcX.gDt(`layer2/${id}`, '', (d) => {
      // filter data: buang yang stts == 'h'
      let filtered = Array.isArray(d) ? d.filter(item => item.stts !== 'h') : [];

      data["layer2"] = filtered;
      if (typeof callback === "function") {
        callback(filtered); // kirim data yang sudah difilter
      }
    });
  }


  $(function () {
    // Ambil param tanggal dari URL
    const params = new URLSearchParams(window.location.search);
    const today = stm('t');
    let initDate = params.get('tgl') || today;

    // Jika URL tidak ada ?tgl=..., set default
    if (!params.has('tgl')) {
      params.set('tgl', today);
      window.history.replaceState({}, '', `?${params.toString()}`);
    }

    // Set nilai awal input tanggal
    $('#tanggalInput').val(initDate);

    // Event input search
    $('#cariDataSj').on('input', function () {
      renderFiltered($(this).val());
    });

    // Event change tanggal
    $('#tanggalInput').on('change', function () {
      const selectedDate = $(this).val();
      params.set('tgl', selectedDate);
      window.history.replaceState({}, '', `?${params.toString()}`);
      loadDataSJ(selectedDate);
    });

    // Load data marketing & data SJ
    fbsSvc = new Fbs(db);
    fbsSvcX = new Fbs(db2);

    // fbsSvcX.gDt('layer2','',(d)=>{
    //   let arr = [];

    //   if (Array.isArray(d)) {
    //     arr = d;
    //   } else if (d && typeof d === 'object') {
    //     arr = Object.values(d);
    //   } else {
    //     console.warn('Data layer2 tidak valid:', d);
    //   }

    //   // group berdasarkan id_kain
    //   data.layer2 = arr.reduce((groups, item) => {
    //     const key = item.id_kain || 'unknown'; // default 'unknown' kalau tidak ada id_kain
    //     if (!groups[key]) groups[key] = [];
    //     groups[key].push(item);
    //     return groups;
    //   }, {});
    // });

    fbsSvcX.gDt('app/data/helper','',(d)=>{
      let arr = [];

      if (Array.isArray(d)) {
        arr = d;
      } else if (d && typeof d === 'object') {
        arr = Object.values(d);
      } else {
        console.warn('Data helper tidak valid:', d);
      }

      data.helper = arr
        .filter(val => val.stts !== '' && val.stts !== 0) // filter stts kosong atau 0
        .map(val => ({
          hlp: val.hlp || '',
          id_hlp: val.id_hlp || ''
        }));
    })

    fbsSvc.gDt('/user', '', (d) => {
      let arr = [];

      if (Array.isArray(d)) {
        arr = d;
      } else if (d && typeof d === 'object') {
        arr = Object.values(d);
      } else {
        console.warn('Data marketing tidak valid:', d);
      }

      data.nmMkt = arr.map(val => ({
        usr: val.usr || '',
        mkt: val.mkt || '',
        id_mkt: val.id_mkt || ''
      }));

      loadDataSJ(initDate);
    });
  });
</script>


<script>
// simpan timer di luar supaya bisa di-clear saat dipanggil lagi
let alertTimer = null;
let alertCountdown = null;

function tampilkanPilihanStockLain(d){
  // getDtStock(d,(r)=>{
  //   console.log(data.tempOlahSj);
  //   console.log(d,r);
  // });
}

function showAlert(message, duration = 3000) {
  const modal = document.getElementById('alertModal');
  const msg = document.getElementById('alertMessage');
  const btnClose = document.getElementById('alertBtn');

  if (!modal || !msg || !btnClose) return;

  // clear timer lama
  if (alertTimer) clearTimeout(alertTimer);
  if (alertCountdown) clearInterval(alertCountdown);

  let timeLeft = Math.ceil(duration / 1000);
  msg.textContent = message;
  btnClose.innerHTML = `<i class="bi bi-x-lg"></i> (${timeLeft})`;

  modal.classList.remove('hidden');
  modal.classList.add('flex', 'opacity-0');

  // fade-in
  setTimeout(() => {
    modal.classList.remove('opacity-0');

    // ðŸ”¥ tambahkan animasi getar
    modal.classList.add('shake');
    setTimeout(() => modal.classList.remove('shake'), 300); // hapus setelah animasi selesai
  }, 10);

  // countdown
  alertCountdown = setInterval(() => {
    timeLeft--;
    btnClose.innerHTML = `<i class="bi bi-x-lg"></i> (${timeLeft})`;
    if (timeLeft <= 0) clearInterval(alertCountdown);
  }, 1000);

  // auto close
  alertTimer = setTimeout(() => {
    closeAlert();
    clearInterval(alertCountdown);
  }, duration);

  // tombol close
  btnClose.onclick = () => {
    clearTimeout(alertTimer);
    clearInterval(alertCountdown);
    closeAlert();
  };

  function closeAlert() {
    modal.classList.add('opacity-0');
    setTimeout(() => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }, 300);
  }
}


  $(document).on("keypress", ".input-hlp", function (e) {
    if (e.which === 13) {
      console.log("Enter ditekan, value:", $(this).val());
    }
  });

</script>

    <script>
      function listenerLayer2() {
        let idKain;

        // buka modal dari tombol dengan ambil data-id-kain
        $(document).on("click", ".open-layer-2", function () {
          idKain = $(this).data("id-kain"); // ambil atribut data-id-kain
          $("#layer-2-modal").removeClass("hidden");
          tampilkanPilihanStockLain(idKain);
        });

        // tutup modal
        $("#close-layer-2, #close-btn-layer-2").on("click", function () {
          $("#layer-2-modal").addClass("hidden");
        });

        // klik di luar konten modal â†’ tutup
        $("#layer-2-modal").on("click", function (e) {
          if (e.target.id === "layer-2-modal") {
            $("#layer-2-modal").addClass("hidden");
          }
        });

        // fungsi isi modal
        function tampilkanPilihanStockLain(id) {
          getDtStock(id,(r)=>{
            // console.log(data.tempOlahSj);
            console.log(id,r);

            let html = r.map(item => {
              return `
                <div class="item border p-1 mb-1 rounded cursor-pointer hover:bg-gray-100" data-id="${item.id_stock}">
                  <strong>(${item.id_stock}) ${item.ltrl} ${item.stts}</strong> 
                  <span class="text-gray-500">[${item.rak} ${item.kol}]</span> | 
                  <span class="text-gray-500">[Out ${item.q !== "0" ? item.q : item.q_o}]</span>
                </div>
              `;
            }).join("");
            // console.log(html);

                // <p>ID Kain: <strong>${id}</strong></p>
                // <p>ðŸ‘‰ Di sini bisa load pilihan stock lain dari server</p>
            $("#modal-content-layer-2 .list-stock").html(html);
          });
        }
      }
    </script>
  </body>
</html>