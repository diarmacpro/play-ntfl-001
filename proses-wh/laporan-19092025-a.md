# Laporan Perubahan Back-End: Penambahan Endpoint `/api/acc-mg` pada main.go dan handlers_1.go

## Deskripsi
Laporan ini merangkum seluruh proses pekerjaan yang dilakukan berdasarkan kronologi diskusi dan permintaan pada sesi ini, terkait penambahan dan perbaikan endpoint API untuk update status pembayaran Surat Jalan (SJ) pada aplikasi Go.

## Tujuan
- Menyediakan endpoint API baru yang dapat diakses frontend untuk mengubah status pembayaran SJ.
- Memastikan struktur kode lebih rapi, modular, dan maintainable.
- Menyelesaikan masalah error dan inkonsistensi yang ditemukan selama proses pengembangan.

---

## Kronologi & Tindakan

### 1. Permintaan Penambahan Endpoint
- **Case:** Diminta membuat endpoint baru `/api/acc-mg` di Go, menggantikan logika PHP lama yang mengupdate status pembayaran SJ.
- **Tindakan:**  
  - Handler baru `AccMgHandler` dibuat di `handlers_1.go`.
  - Fungsi utilitas waktu `NowMySQLDatetime` juga ditambahkan agar timestamp sesuai format MySQL.
  - Endpoint didaftarkan di router pada `main.go`.

### 2. Refactor & Perapihan Struktur Kode
- **Case:** Struktur file handler sebelumnya kurang rapi, terdapat duplikasi import dan penempatan fungsi yang tidak konsisten.
- **Tindakan:**  
  - Handler dan fungsi utilitas dipindahkan seluruhnya ke `handlers_1.go`.
  - Struktur file dirapikan: satu blok import, urutan fungsi konsisten, tidak ada duplikasi.

### 3. Penyesuaian Router di main.go
- **Case:** Endpoint baru perlu didaftarkan agar bisa diakses frontend.
- **Tindakan:**  
  - Pada fungsi `setupRoutes` di `main.go`, ditambahkan:
    ```go
    mux.HandleFunc("/api/acc-mg", s.AccMgHandler)
    ```
  - Penjelasan: Baris ini memastikan permintaan ke `/api/acc-mg` akan diproses oleh handler yang sudah dibuat.

---

## Before

- **Belum ada endpoint `/api/acc-mg` di Go.**
- **Logika update status pembayaran masih di PHP.**
- **Struktur file handler belum rapi.**

---

## After

### handlers_1.go
```go
package main

import (
    "net/http"
    "time"
)

func NowMySQLDatetime() string {
    return time.Now().Format("2006-01-02 15:04:05")
}

func (s *Server) AccMgHandler(w http.ResponseWriter, r *http.Request) {
    idSj := r.URL.Query().Get("id_sj")
    idM := r.URL.Query().Get("id_m")
    if idSj == "" || idM == "" {
        http.Error(w, "id_sj and id_m required", http.StatusBadRequest)
        return
    }
    dttmnow := NowMySQLDatetime()
    query := `UPDATE tb_sj SET id_m = ?, d_mgr = ?, bayar = 1 WHERE id_sj = ? AND d_mgr IS NULL`
    res, err := s.db.Exec(query, idM, dttmnow, idSj)
    if err != nil {
        http.Error(w, "0", http.StatusInternalServerError)
        return
    }
    rowsAffected, _ := res.RowsAffected()
    w.Header().Set("Content-Type", "application/json; charset=utf-8")
    if rowsAffected > 0 {
        w.Write([]byte("1"))
    } else {
        w.Write([]byte("0"))
    }
}
```
**Penjelasan:**  
Handler ini menerima parameter `id_sj` dan `id_m`, lalu melakukan update pada tabel `tb_sj` jika syarat terpenuhi. Response berupa `"1"` jika update berhasil, `"0"` jika gagal.

### main.go
```go
// Pada setupRoutes:
mux.HandleFunc("/api/acc-mg", s.AccMgHandler)
```
**Penjelasan:**  
Endpoint baru didaftarkan agar bisa diakses frontend.

---

## Hasil / Kesimpulan
- Endpoint `/api/acc-mg` berhasil diimplementasikan sesuai kebutuhan.
- Struktur kode lebih rapi dan maintainable.
- Proses update status pembayaran SJ kini dapat dilakukan langsung dari aplikasi Go.

---

## Contoh Pemanggilan Endpoint

**HTTP GET:**
```
GET https://app.weva.my.id/api/acc-mg?id_sj=12345&id_m=678
```
**Response jika berhasil:**  
```
1
```
**Response jika gagal:**  
```
0
```
---

Laporan ini sepenuhnya didasarkan pada kronologi, diskusi, dan tindakan yang telah dilakukan selama sesi ini.