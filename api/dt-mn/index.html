<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Verifikasi Barang Masuk</title>
        <link rel="icon" href="https://cdn-icons-png.freepik.com/512/628/628300.png" />
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Bootstrap Icons CDN -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
        <style>
        </style>
    </head>
    <body>
        <div class="p-6 bg-gray-100 min-h-screen">
            <div class="mx-auto bg-white shadow-lg rounded-xl">
                <!-- Header Bar -->
                <div class="flex items-center px-4 py-2 border-b border-gray-200 bg-gray-50 sticky top-0 z-20">
                    <!-- Left group: Renew & Search -->
                    <div class="flex items-center gap-2 flex-1 min-w-0">
                        <button onclick="window.location.href='./'" class="flex items-center bg-red-700 text-white px-3 py-1 rounded hover:bg-gray-900">
                            <i class="bi bi-power"></i>
                        </button>

                        <button id="btnRenew" class="flex items-center bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-900">
                            <i class="bi-arrow-clockwise mr-2"></i>
                        </button>
                        <input id="searchInput" type="text" placeholder="Cari..." class="w-full min-w-0 flex-grow px-1 py-0 border border-gray-300 rounded-lg focus:outline-none focus:ring-0 rounded-none transition mx-3" />
                        <!-- focus:outline-none focus:ring-0 focus:border-none rounded-none border-none -->
                    </div>
                    <!-- Right group: Data count, checked badge, check/uncheck, proses -->
                    <div class="flex items-center gap-2 ml-auto flex-none">
                        <span id="dataCount" class="text-xs text-gray-600">0 of 0</span>
                        <span id="checkedCount" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-300 ml-2">Checked: 0</span>
                        <button id="btnClearChecked" title="Clear Checked" class="flex items-center bg-red-600 text-white px-3 py-1 rounded hover:bg-red-800 focus:outline-none">
                            <i class="bi-x-lg mr-2"></i>Clear Checked
                        </button>
                        <button id="btnSelectAll" title="Select All" class="flex items-center bg-green-600 text-white px-3 py-1 rounded hover:bg-green-800 focus:outline-none ml-1">
                            <i class="bi-check2-all mr-2"></i>Select All
                        </button>
                        <button id="btnProses" class="flex items-center bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-800 ml-2">
                            <i class="bi-play-fill mr-2"></i>Proses Data
                        </button>
                        <button id="btnProses" class="flex items-center bg-gray-700 text-white px-3 py-1 rounded hover:bg-blue-800 ml-2">
                            <i class="bi bi-chevron-double-down"></i>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <div style="max-height:700px;overflow:auto;">
                        <table class="min-w-full divide-y divide-gray-200 border border-gray-400">
                            <thead class="bg-gray-900 text-white sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[60px] border border-gray-400">ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[60px] border border-gray-400">PO</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border border-gray-400">Barang</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[100px] border border-gray-400">LTRL</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[60px] border border-gray-400">SUP</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[60px] border border-gray-400">Nett</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[60px] border border-gray-400">SST</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[60px] border border-gray-400">%</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[100px] border border-gray-400">LOC</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[100px] border border-gray-400">HLP</th>
                                </tr>
                            </thead>
                            <tbody id="dataTable" class="divide-y divide-gray-100 bg-white text-sm text-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal for Proses Data -->
        <div id="modalProses" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
            <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-2xl flex flex-col items-center">
                <h2 class="text-lg font-bold mb-4">Bulk Action</h2>
                <div id="bulkForm" class="w-full flex flex-col gap-3 mb-2">
                    <div class="relative w-full" id="qtyWrapper">
                        <label for="inputQtyNett" class="block text-xs font-semibold mb-1">Qty Nett</label>
                        <input id="inputQtyNett" name="qty_nett" type="text"
                            placeholder="Masukkan Qty Nett"
                            class="border rounded px-3 py-2 w-full pr-10 text-right"
                            autocomplete="off"
                            inputmode="decimal"
                            pattern="^\d+(\.\d{1,2})?$" />
                    </div>

                    <div class="relative w-full" id="lokasiWrapper">
                        <label for="inputLokasi" class="block text-xs font-semibold mb-1">Lokasi</label>
                        <input id="inputLokasi" name="lokasi" type="text" placeholder="Masukkan lokasi"
                                class="border rounded px-3 py-2 w-full pr-10" autocomplete="off">
                    </div>
                    <div class="relative w-full" id="helperWrapper">
                        <label for="inputHelper" class="block text-xs font-semibold mb-1">Helper</label>
                        <input id="inputHelper" name="helper" type="text"
                            placeholder="Masukkan helper"
                            class="border rounded px-3 py-2 w-full pr-10"
                            autocomplete="off" />
                    </div>

                    <div>
                        <label for="inputQtyNett" class="block text-xs font-semibold mb-1">Id Selected</label>
                        <textarea id="textAreaMenampungIdStock" rows=8 class="border rounded px-3 py-2 w-full"></textarea>
                    </div>
                    <div class="flex w-full gap-2">
                        <button id="btnPrintOnline" class="bg-amber-600 text-white px-4 py-2 rounded hover:bg-amber-800 w-1/2">Print Online</button>
                        <button id="btnPrintLangsung" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-800 w-1/2">Print Langsung</button>
                    </div>
                </div>
                <hr class="w-full border border-gray-300 my-3">
                <div class="flex w-full gap-2 mt-2">
                    <button id="btnBatal" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-800 w-1/2">Batal</button>
                    <button id="btnProsesModal" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-800 w-1/2">Proses</button>
                </div>
            </div>
        </div>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.9.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/diarmacpro/cdnku@4849b7e3a19e88b14d27454f60d16c062e16648d/core.js" integrity="sha256-xxU8WD/MI8uoZ1geRPVqbSvo6MuHLOUHfu/0Vg8Bewg=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/diarmacpro/cdnku@35e5003dbb8177b966f240b861c2bb547fc7f013/firebase-olah-data/f.o.d_v.0.2.js" integrity="sha256-5kpwc2PDnZf+BOBdrhIYWlFq4QlxajP7UhRJZtU3Wos=" crossorigin="anonymous"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, update, push, query, remove, orderByChild, equalTo, onValue, off } from 'https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js';

        const app = initializeApp({ databaseURL: "https://stock-wv-default-rtdb.asia-southeast1.firebasedatabase.app" });
        const db = getDatabase(app);
        Object.assign(window, { db, ref, set, get, update, push, query, remove, orderByChild, equalTo, onValue, off });
    </script>

    <script src="./script.js"></script>
    <script>
        (function() {
            // Nilai hash base64 yang valid (gabungan 5 hash SHA-256 huruf dipisah '+', lalu base64)
            const kodeHashBase64 = "YTFmY2U0MzYzODU0ZmY4ODhjZmY0YjhlNzg3NWQ2MDBjMjY4MjM5MDQxMmE4Y2Y3OWIzN2QwYjExMTQ4YjBmYStjYTk3ODExMmNhMWJiZGNhZmFjMjMxYjM5YTIzZGM0ZGE3ODZlZmY4MTQ3YzRlNzJiOTgwNzc4NWFmZWU0OGJiKzUwZTcyMWU0OWMwMTNmMDBjNjJjZjU5ZjIxNjM1NDJhOWQ4ZGYwMjQ2NGVmZWI2MTVkMzEwNTFiMGZkZGMzMjYrZGU3ZDFiNzIxYTFlMDYzMmI3Y2YwNGVkZjUwMzJjOGVjZmZhOWY5YTA4NDkyMTUyYjkyNmYxYTVhN2U3NjVkNyswNDNhNzE4Nzc0YzU3MmJkOGEyNWFkYmViMWJmY2Q1YzAyNTZhZTExY2VjZjlmOWMzZjkyNWQwZTUyYmVhZjg5";

            function sha256(text) {
                if (!window.crypto || !window.crypto.subtle || typeof window.TextEncoder === 'undefined') {
                    alert('Fitur crypto.subtle tidak tersedia di browser ini. Silakan gunakan browser modern.');
                    return Promise.reject(new Error('crypto.subtle not available'));
                }
                const data = new TextEncoder().encode(text);
                return crypto.subtle.digest('SHA-256', data).then(buffer => {
                    return Array.from(new Uint8Array(buffer))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');
                });
            }

            function getCookie(name) {
                return document.cookie.split('; ').reduce((acc, pair) => {
                    const [key, value] = pair.split('=');
                    return key === name ? value : acc;
                }, null);
            }

            function setCookie(name, value, minutes) {
                const expires = new Date(Date.now() + minutes * 60000).toUTCString();
                document.cookie = `${name}=${value}; expires=${expires}; path=/`;
            }

            async function cekAkses() {
                const cookieIjin = getCookie('ijin');
                if (cookieIjin) {
                    // Ambil kembali base64 target -> decode -> pecah '+' -> gabung ulang tanpa '+'
                    const decoded = atob(kodeHashBase64).split('+').join('');
                    const expectedFinalHash = await sha256('1' + decoded);

                    if (cookieIjin === expectedFinalHash) {
                        console.log('Akses diizinkan.');
                        return;
                    }
                }

                const input = prompt('Akses halaman ini hanya untuk petugas yang berwenang.\nMasukkan kode rahasia:');
                if (!input || input.length !== 5) {
                    alert('Kode salah atau tidak valid.');
                    return;
                }

                const hashList = await Promise.all([...input].map(sha256));
                const gabungan = hashList.join('+');
                const encoded = btoa(gabungan);

                if (encoded !== kodeHashBase64) {
                    alert('Kode salah. Akses ditolak.');
                    return;
                }

                // Cookie sah, buat hash akhir dan simpan
                const hashTanpaPlus = hashList.join('');
                const finalHash = await sha256('1' + hashTanpaPlus);
                setCookie('ijin', finalHash, 30);
                alert('Akses diberikan selama 30 menit.');
            }

            cekAkses();
        })();



        var fbsSvc, dataMainOnFbs, dataLocal = {
            dataHelper: {},
            dataRak: {},
            dataKol: {}
        };


        var checkedRows = {};
        let totalData = 0;
        var dataCHecked = {};
        
        const dataCount = document.getElementById('dataCount');
        const checkedCount = document.getElementById('checkedCount');

        // Load reference data
        function loadReferenceData(callback) {
            let loadCount = 0;
            const checkComplete = () => {
                loadCount++;
                if (loadCount === 3) callback();
            };
            
            fbsSvc.gDt('/app/data/helper', '', (dataHelper) => {
                // Convert to id-based lookup object
                dataLocal.dataHelper = _.reduce(dataHelper, (result, value) => {
                    result[value.id_hlp] = value;
                    return result;
                }, {});
                checkComplete();
            });

            fbsSvc.gDt('/app/data/rak', '', (dataRak) => {
                // Build lookup by i for display
                dataLocal.dataRak = _.reduce(dataRak, function(result, value) {
                    result[value.i] = value;
                    return result;
                }, {});
                checkComplete();
            });

            fbsSvc.gDt('/app/data/kol', '', (dataKol) => {
                // Build lookup by i for display
                dataLocal.dataKol = _.reduce(dataKol, function(result, value) {
                    result[value.i] = value;
                    return result;
                }, {});
                checkComplete();
            });

            fbsSvc.gDt('/app/data/kain', '', (dataKain) => {
                dataLocal.dataKain = dataKain; // keep as array
                // Build lookup for rendering
                dataLocal._kainLookup = _.reduce(dataKain, function(result, value) {
                    result[value.id_kain] = value;
                    return result;
                }, {});
                checkComplete();
            });
        }

        function getHelperName(id) {
            return _.get(dataLocal.dataHelper, [id, 'hlp'], id);
        }

        function getRakName(id) {
            return (dataLocal.dataRak && dataLocal.dataRak[id]) ? dataLocal.dataRak[id].v : id;
        }

        function getKolName(id) {
            return (dataLocal.dataKol && dataLocal.dataKol[id]) ? dataLocal.dataKol[id].v : id;
        }

        function getKainName(id) {
            return (dataLocal._kainLookup && dataLocal._kainLookup[id]) ? dataLocal._kainLookup[id].k : id;
        }

        /*
        function properText(text) {
        return text
            .toLowerCase()
            .replace(/\b\w/g, char => char.toUpperCase());
        }
        */
        
        function renderTableData(data) {
            window._lastData = data;
            let filtered = data;
            // console.log("xxx",filtered)
            // console.log("xxx",filtered.length)
            let isSearchActive = window._searchQuery && window._searchQuery.length > 0;
            if (isSearchActive) {
                // Multi-keyword, order-insensitive search
                const keywords = window._searchQuery.split(/\s+/).filter(Boolean);
                filtered = _.filter(data, function(item) {
                    const searchStr = [
                        getKainName(item.id_kain),
                        item.id_stock,
                        item.no_po,
                        item.lot,
                        item.rol,
                        getRakName(item.kd_rak),
                        getKolName(item.kd_kol),
                        getHelperName(item.id_hlp)
                    ].join(' ').toLowerCase();
                    return keywords.every(kw => searchStr.includes(kw));
                });
                console.log("xxx",filtered)
            }
            // Update data count and checked count
            if (window.dataMainOnFbs && typeof window.dataMainOnFbs === 'object') {
                totalData = Object.keys(window.dataMainOnFbs).length;
            }
            if (dataCount) {
                // console.log(filtered.length);
                dataCount.textContent = `${typeof filtered.length === 'undefined' ? totalData : (filtered.length === 0 ? 0 : filtered.length)} of ${totalData}`;
            }
            if (checkedCount) {
                const checked = Object.values(checkedRows).filter(Boolean).length;
                checkedCount.textContent = `Checked: ${checked}`;
            }
            const tableBody = document.getElementById('dataTable');
            tableBody.innerHTML = '';
            _.forEach(filtered, (item) => {
                const row = document.createElement('tr');
                row.className = '';
                row.setAttribute('data-id', item.id_stock);
                row.setAttribute('data-key', item.key);
                if (checkedRows[item.id_stock]) {
                    row.classList.add('bg-blue-100', 'font-bold');
                    row.setAttribute('data-select', 'true');
                } else {
                    row.setAttribute('data-select', 'false');
                }
                const lotRoll = (item.lot || '') + ' # ' + (item.rol || '');
                const kolRak = (getRakName(item.kd_rak) || '') + ' ' + (getKolName(item.kd_kol) || '');
                const selisih = (item.q_nett > 0 && item.q_sup > 0) ? (item.q_nett - item.q_sup) : 0;
                const persentase = (selisih !== 0 && item.q_sup > 0)
                    ? ((selisih / item.q_sup) * 100).toFixed(2) + '%'
                    : '0%';
                const columns = [
                    item.id_stock || '',
                    item.no_po || '',
                    getKainName(item.id_kain),
                    lotRoll,
                    item.q_sup || '0.00',
                    item.q_nett || '0.00',
                    selisih.toFixed(2),
                    persentase,
                    kolRak,
                    getHelperName(item.id_hlp)
                ];
                // console.log(columns);
                columns.forEach((val, idx) => {
                    const cell = document.createElement('td');
                    cell.className = 'px-4 py-1 border border-gray-400';
                    
                    if (idx == 5) {
                        cell.className = 'px-1 py-0 border border-gray-400 text-center';
                    }
                    
                    // Kolom nett (5), loc (8), hlp (9) pakai span khusus
                    if (idx === 5 || idx === 8 || idx === 9) {
                        const span = document.createElement('span');
                        span.className = 'edit-inline w-full inline-block min-h-[1rem] cursor-pointer';
                        span.textContent = val;
                        cell.appendChild(span);
                    } else {
                        cell.textContent = val;
                    }
                    if (idx === 5 || idx === 6) {
                        const num = parseFloat(val);
                        if (num < 0) cell.classList.add('text-red-600');
                        else if (num > 0) cell.classList.add('text-blue-600');
                    }
                    // Hanya kolom 0-4 yang bisa select
                    if (idx <= 4) {
                        cell.classList.add('hover:bg-gray-50', 'cursor-pointer');
                        cell.onclick = function(e) {
                            e.stopPropagation();
                            checkedRows[item.id_stock] = !checkedRows[item.id_stock];
                            row.classList.toggle('bg-blue-100', checkedRows[item.id_stock]);
                            row.classList.toggle('font-bold', checkedRows[item.id_stock]);
                            row.setAttribute('data-select', checkedRows[item.id_stock] ? 'true' : 'false');
                            if (checkedRows[item.id_stock]) {
                                dataCHecked[item.id_stock] = {
                                    id_stock: item.id_stock,
                                    no_po: item.no_po,
                                    id_kain: item.id_kain,
                                    kain: getKainName(item.id_kain),
                                    lot: item.lot,
                                    rol: item.rol,
                                    q_sup: item.q_sup,
                                    q_nett: item.q_nett,
                                    selisih: selisih,
                                    persentase: persentase,
                                    rak: (dataLocal.dataRak[item.kd_rak] && dataLocal.dataRak[item.kd_rak].v) || null,
                                    kol: (dataLocal.dataKol[item.kd_kol] && dataLocal.dataKol[item.kd_kol].v) || null,
                                    helper: (dataLocal.dataHelper[item.id_hlp] && dataLocal.dataHelper[item.id_hlp].hlp) || null,
                                    lotRoll: lotRoll,
                                    kolRak: kolRak
                                };
                            } else {
                                delete dataCHecked[item.id_stock];
                            }
                            updateCheckedInfo();
                            updateBtnProsesState();
                        };
                    } else {
                        // Pastikan kolom lain tidak bisa select
                        cell.classList.remove('hover:bg-gray-50', 'cursor-pointer');
                        cell.onclick = null;
                    }
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });
            updateCheckedInfo();
        }

        function getSelectedDataKeys() {
            // Clear pencarian
            if ($('#searchInput').length) $('#searchInput').val('');
            // Reset query pencarian global
            window._searchQuery = '';
            // Render ulang semua data (tanpa filter)
            filterAndRenderTable();
            // Ambil hanya <tr> yang memiliki data-select="true" di dalam #dataTable
            const $rows = $('#dataTable tr[data-select="true"]');
            const jumlahDipilih = $rows.length;
            const dataKeys = $rows.map(function() {
                return $(this).data('key');
            }).get(); // Konversi ke array JavaScript biasa
            return {
                jumlah: jumlahDipilih,
                dataKeys: dataKeys
            };
        }

        function getSelectedDataMain() {
            // Clear pencarian
            if ($('#searchInput').length) $('#searchInput').val('');
            window._searchQuery = '';
            filterAndRenderTable();
            // Ambil hanya <tr> yang memiliki data-select="true" di dalam #dataTable
            const $rows = $('#dataTable tr[data-select="true"]');
            const dataKeys = $rows.map(function() {
                return $(this).data('id');
            }).get();
            // Ambil data dari dataMainOnFbs sesuai urutan dataKeys
            let mainData = [];
            if (window.dataMainOnFbs && Array.isArray(window.dataMainOnFbs)) {
                mainData = window.dataMainOnFbs.filter(item => dataKeys.includes(item.id_stock));
            } else if (window.dataMainOnFbs && typeof window.dataMainOnFbs === 'object') {
                // Jika dataMainOnFbs object (bukan array)
                mainData = Object.values(window.dataMainOnFbs).filter(item => dataKeys.includes(item.id_stock));
            }
            return {
                jumlah: dataKeys.length,
                dataKeys: dataKeys,
                dataMain: mainData
            };
        }

        function filterAndRenderTable() {
            // Always filter from the original data
            const data = window._dataMainOnFbs || [];
            let filtered = data;

            // console.log(dataMainOnFbs);
            // console.log(data);
            // console.log("filtered",filtered);
            if (window._searchQuery && window._searchQuery.length > 0) {
                const keywords = window._searchQuery.split(/\s+/).filter(Boolean);
                filtered = _.filter(data, function(item) {
                    const searchStr = [
                        getKainName(item.id_kain),
                        item.id_stock,
                        item.no_po,
                        item.lot,
                        item.rol,
                        getRakName(item.kd_rak),
                        getKolName(item.kd_kol),
                        getHelperName(item.id_hlp)
                    ].join(' ').toLowerCase();
                    return keywords.every(kw => searchStr.includes(kw));
                });
            }
            renderTableData(filtered);
        }

        function updateCheckedInfo() {
            // Show checked count in checkedCount span
            const checkedCount = document.getElementById('checkedCount');
            if (checkedCount) {
                const checked = Object.values(checkedRows).filter(Boolean).length;
                checkedCount.textContent = `Checked: ${checked}`;
            }
        }

        function callData(url, payload, callback) {
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (typeof callback === 'function') {
                    callback(null, data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (typeof callback === 'function') {
                    callback(error, null);
                }
            });
        }

        function callDataMain(tgl, callback) {
            callData('https://cdn.weva.my.id/apix/dtMn', { tgl }, callback);
        }

        function generateDataMainOnFbs(tgl){
            callDataMain(tgl,(err_data,data)=>{
                console.log("Data Ini Baru");
                if (err_data) {
                    console.error(err_data);
                } else if (!data || (Array.isArray(data) && data.length === 0) || (typeof data === 'object' && Object.keys(data).length === 0)) {
                    alert('Data tidak tersedia untuk tanggal tersebut!');
                    window.location.href = './';
                } else {
                    _.map(data,(v,k)=>{
                        fbsSvc.iDtKy(`/app/verif-data-masuk/${tgl}`,v,()=>{});
                    })
                }
            })
        }


/*
        function checkAndFixDuplicates(tgl, callback) {
            // Ambil data dari Firebase
            fbsSvc.gDt(`/app/verif-data-masuk/${tgl}`, '', (data) => {
                if (!data || _.isEmpty(data)) {
                    if (typeof callback === 'function') callback();
                    return;
                }
                // Deteksi duplikat berdasarkan id_stock
                const countById = _.countBy(data, 'id_stock');
                const hasDuplicate = Object.values(countById).some(cnt => cnt > 1);
                if (!hasDuplicate) {
                    if (typeof callback === 'function') callback();
                    return;
                }
                // Jika ada duplikat, hapus semua data di path utama
                fbsSvc.delDt(`/app/verif-data-masuk/${tgl}`, '', () => {
                    // Fetch data baru dari API
                    callDataMain(tgl, (err, newData) => {
                        if (!err && newData) {
                            _.map(newData, (v) => {
                                fbsSvc.iDtKy(`/app/verif-data-masuk/${tgl}`, v, () => {});
                            });
                            // Tunggu sebentar lalu callback
                            setTimeout(() => {
                                if (typeof callback === 'function') callback();
                            }, 1200);
                        } else {
                            if (typeof callback === 'function') callback();
                        }
                    });
                });
            });
        }

        function getDataMainOnFbs(tgl){
            checkAndFixDuplicates(tgl, () => {
                fbsSvc.gDt(`/app/verif-data-masuk/${tgl}`, '', (data) => {
                    dataMainOnFbs = data;
                    window._dataMainOnFbs = data; // Save original data for filtering
                    // If data is empty or null, generate and reload
                    if (!data || _.isEmpty(data)) {
                        generateDataMainOnFbs(tgl);
                        // After generate, reload data (with delay to ensure write completes)
                        setTimeout(() => getDataMainOnFbs(tgl), 1200);
                    } else {
                        filterAndRenderTable();
                    }
                });
            });
        }
        */
var dtTempTry = {};

function getDataMainOnFbs(tgl) {
  fbsSvc.gDt(`/app/verif-data-masuk/${tgl}`, '', (data) => {
    data = Object.entries(data || {}).map(([key, value]) => ({
        key,
        ...value
    }));
    // console.log(data);

    // Jika data kosong/null → langsung callDataMain
    if (!data || _.isEmpty(data)) {
      console.warn('Data kosong, akan generate ulang...');
      callDataMain(tgl, (err, newData) => {
        if (!err && Array.isArray(newData)) {
          _.forEach(newData, (item) => {
            fbsSvc.iDtKy(`/app/verif-data-masuk/${tgl}`, item, () => {});
          });
          // Setelah insert ulang, panggil ulang fungsi ini
          setTimeout(() => getDataMainOnFbs(tgl), 1200);
        } else {
          console.error('Gagal ambil data baru dari callDataMain.');
        }
      });
      return; // Stop proses selanjutnya
    }

    // Pastikan data dalam bentuk array
    const dataArray = Array.isArray(data) ? data : Object.values(data);
    const grouped = _.groupBy(dataArray, 'id_stock');

    dtTempTry = {
      data: dataArray,
      cA: dataArray.length,
      cB: Object.keys(grouped).length
    };

    // Jika ada duplikat id_stock, hapus & ambil ulang
    if (dtTempTry.cA !== dtTempTry.cB) {
      console.warn('Data tidak konsisten, ada duplikat id_stock');
      fbsSvc.delDt(`/app/verif-data-masuk/${tgl}`, () => {
        callDataMain(tgl, (err, newData) => {
          if (!err && Array.isArray(newData)) {
            _.forEach(newData, (item) => {
              fbsSvc.iDtKy(`/app/verif-data-masuk/${tgl}`, item, () => {});
            });
            setTimeout(() => getDataMainOnFbs(tgl), 1200);
          } else {
            console.error('Gagal ambil data baru dari callDataMain.');
          }
        });
      });
      return;
    }

    // Data valid dan tidak duplikat
    console.log('Data valid, tidak ada duplikat id_stock');
    dataMainOnFbs = dataArray;
    window._dataMainOnFbs = dataArray;

    filterAndRenderTable();
  });
}


        // function listenerModalProses() {
        //     $('#inputLokasi').on('keydown', function(e) {
        //         if (e.key === 'Enter') {
        //             e.preventDefault(); // mencegah form submit jika ada
        //             const inputValue = $(this).val();

        //             cekLokasiAsync(inputValue).then(hasil => {
        //                 console.log(hasil);
        //                 if (hasil) {
        //                     $(this).val(hasil.loc); // gunakan hasil.loc untuk ditampilkan
        //                 } else {
        //                     $(this).val('');
        //                 }
        //             });
        //         }
        //     });
        // }

        function listenerModalProses() {
            // Lokasi
            $('#inputLokasi').on('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const inputEl = $(this);
                    const inputValue = inputEl.val();

                    cekLokasiAsync(inputValue).then(hasil => {
                        console.log(hasil);
                        if (hasil) {
                            inputEl
                                .val(hasil.loc)
                                .prop('disabled', true)
                                .attr('data-k-rak', hasil.kode.rak)
                                .attr('data-k-kol', hasil.kode.kol)
                                .attr('data-has-val', true)
                                .attr('data-loc', hasil.loc);

                            if ($('#btnResetLokasi').length === 0) {
                                const resetBtn = $('<button id="btnResetLokasi" type="button" class="inline-flex items-center px-2 py-0.5 text-xs font-semibold text-red-700 bg-red-100 rounded-full hover:bg-red-200">clear lokasi</button>');
                                $('#lokasiWrapper').append(resetBtn);

                                resetBtn.on('click', function () {
                                    inputEl
                                        .val('')
                                        .prop('disabled', false)
                                        .removeAttr('data-k-rak')
                                        .removeAttr('data-k-kol')
                                        .removeAttr('data-has-val')
                                        .removeAttr('data-loc')
                                        .focus();
                                    $(this).remove();
                                });
                            }
                        } else {
                            inputEl.val('');
                        }
                    });
                }
            });

            // Helper
            $('#inputHelper').on('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const inputEl = $(this);
                    const inputValue = inputEl.val();

                    cekHelperAsync(inputValue).then(hasil => {
                        console.log(hasil);
                        if (hasil) {
                            inputEl
                                .val(hasil.hlp)
                                .prop('disabled', true)
                                .attr('data-id-hlp', hasil.id_hlp)
                                .attr('data-hlp', hasil.hlp)
                                .attr('data-has-val', true);

                            if ($('#btnResetHelper').length === 0) {
                                const resetBtn = $('<button id="btnResetHelper" type="button" class="inline-flex items-center px-2 py-0.5 text-xs font-semibold text-red-700 bg-red-100 rounded-full hover:bg-red-200">clear helper</button>');
                                $('#helperWrapper').append(resetBtn);

                                resetBtn.on('click', function () {
                                    inputEl
                                        .val('')
                                        .prop('disabled', false)
                                        .removeAttr('data-id-hlp')
                                        .removeAttr('data-hlp')
                                        .removeAttr('data-has-val')
                                        .focus();
                                    $(this).remove();
                                });
                            }
                        } else {
                            inputEl.val('');
                        }
                    });
                }
            });

            // Qty Nett (maks 2 angka di belakang koma)
            $('#inputQtyNett').on('input', function () {
                const inputEl = $(this);
                const val = inputEl.val();

                // Validasi: hanya angka dan maksimal 2 digit desimal
                if (!/^\d*(\.\d{0,2})?$/.test(val)) {
                    inputEl.val(val.slice(0, -1));
                }
            });

            $('#inputQtyNett').on('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const inputEl = $(this);
                    const val = inputEl.val();

                    if (val && /^\d+(\.\d{1,2})?$/.test(val)) {
                        inputEl
                            .val(parseFloat(val).toFixed(2))
                            .prop('disabled', true)
                            .attr('data-has-val', true)
                            .attr('data-qty', val);

                        if ($('#btnResetQty').length === 0) {
                            const resetBtn = $('<button id="btnResetQty" type="button" class="inline-flex items-center px-2 py-0.5 text-xs font-semibold text-red-700 bg-red-100 rounded-full hover:bg-red-200">clear qty</button>');
                            $('#qtyWrapper').append(resetBtn);

                            resetBtn.on('click', function () {
                                inputEl
                                    .val('')
                                    .prop('disabled', false)
                                    .removeAttr('data-has-val')
                                    .removeAttr('data-qty')
                                    .focus();
                                $(this).remove();
                            });
                        }
                    } else {
                        inputEl.val('');
                    }
                }
            });
        }

        // Tambahkan event delegation untuk edit-inline agar bisa edit inline
        $(document).on('click', 'span.edit-inline', function(e) {
            e.stopPropagation();
            const span = $(this);
            if (span.data('editing')) return;
            span.data('editing', true);
            const oldVal = span.text();
            // console.log(oldVal);
            const idx = span.closest('td').index();
            const input = $('<input type="text" class="w-full p-0 font-medium text-red-600 focus:outline-none focus:ring-0 focus:border-none rounded-none border-none text-right" />')
                .val(oldVal)
                .css({ minWidth: '40px', maxWidth: '120px' })
                .on('keydown', function(ev) {
                    if (ev.key === 'Enter' || ev.key === 'Tab') {
                        if (idx === 5) {
                            const inputVal = this.value;
                            // Validasi: hanya angka dan maksimal 2 digit desimal
                            if (/^\d+(\.\d{1,2})?$/.test(inputVal)) {
                                const newNett = parseFloat(inputVal).toFixed(2);
                                span.text(newNett);
                                // Hitung ulang kolom sst (idx 6) dan persentase (idx 7)
                                const row = span.closest('tr');
                                const tdSup = row.find('td').eq(4); // q_sup
                                const tdSst = row.find('td').eq(6); // sst
                                const tdPersen = row.find('td').eq(7); // %
                                const q_sup = parseFloat(tdSup.text()) || 0;
                                const q_nett = parseFloat(newNett) || 0;
                                const selisih = (q_nett > 0 && q_sup > 0) ? (q_nett - q_sup) : 0;
                                const persentase = (selisih !== 0 && q_sup > 0)
                                    ? ((selisih / q_sup) * 100).toFixed(2) + '%'
                                    : '0%';
                                // Update kolom sst dan %
                                tdSst.text(selisih.toFixed(2));
                                tdPersen.text(persentase);
                                // Warnai sesuai logic awal
                                tdSst.removeClass('text-red-600 text-blue-600');
                                if (selisih < 0) tdSst.addClass('text-red-600');
                                else if (selisih > 0) tdSst.addClass('text-blue-600');
                                tdPersen.removeClass('text-red-600 text-blue-600');
                                if (parseFloat(persentase) < 0) tdPersen.addClass('text-red-600');
                                else if (parseFloat(persentase) > 0) tdPersen.addClass('text-blue-600');
                                // Simpan ke dataInputRow
                                const id = row.find('td').eq(0).text();
                                window.dataInputRow = window.dataInputRow || {};
                                if (id) {
                                    window.dataInputRow[id] = window.dataInputRow[id] || {};
                                    window.dataInputRow[id].nett = newNett;
                                }
                                span.data('editing', false);
                                span.show();
                                input.remove();
                                // Optional: auto-advance ke kolom lokasi (col 8)
                                // const tdLokasi = row.find('td').eq(8);
                                // const spanLokasi = tdLokasi.find('span.edit-inline');
                                // if (spanLokasi.length && !spanLokasi.data('editing')) {
                                //     spanLokasi.trigger('click');
                                // }
                            } else {
                                span.text(oldVal); // Kembalikan ke value default jika tidak valid
                                span.data('editing', false);
                                span.show();
                                input.remove();
                            }
                        } else if (idx === 8) {
                            const inputVal = this.value;
                            const row = span.closest('tr');
                            const id = row.find('td').eq(0).text();
                            cekLokasiAsync(inputVal).then(hasil => {
                                if (hasil) {
                                    span.text(hasil.loc);
                                    // Simpan ke dataInputRow
                                    window.dataInputRow = window.dataInputRow || {};
                                    if (id) {
                                        window.dataInputRow[id] = window.dataInputRow[id] || {};
                                        window.dataInputRow[id].loc = hasil.loc;
                                        window.dataInputRow[id].kode_rak = hasil.kode.rak;
                                        window.dataInputRow[id].kode_kol = hasil.kode.kol;
                                    }
                                    span.data('editing', false);
                                    span.show();
                                    input.remove();
                                    // Auto-advance to HELPER (col 9)
                                    // const tdHelper = span.closest('tr').find('td').eq(9);
                                    // const spanHelper = tdHelper.find('span.edit-inline');
                                    // if (spanHelper.length && !spanHelper.data('editing')) {
                                    //     spanHelper.trigger('click');
                                    // }
                                } else {
                                    span.text(oldVal); // Kembalikan ke value default jika tidak valid
                                    span.data('editing', false);
                                    span.show();
                                    input.remove();
                                }
                            });
                        } else if (idx === 9) {
                            const inputVal = this.value;
                            const row = span.closest('tr');
                            const id = row.find('td').eq(0).text();
                            cekHelperAsync(inputVal).then(hasil => {
                                if (hasil) {
                                    span.text(hasil.hlp);
                                    // Simpan ke dataInputRow
                                    window.dataInputRow = window.dataInputRow || {};
                                    if (id) {
                                        const keyPerRow = row.data('key');
                                        const dataMainPerRow = _.find(dataMainOnFbs, { key: keyPerRow });
                                        window.dataInputRow[id] = window.dataInputRow[id] || {};
                                        window.dataInputRow[id].hlp = hasil.hlp;
                                        window.dataInputRow[id].id_hlp = hasil.id_hlp;
                                        window.dataInputRow[id].id_stock = id;
                                        window.dataInputRow[id].key = keyPerRow;
                                        console.log(dataInputRow);
                                        console.log(dataMainPerRow);
                                        pR('https://cdn.weva.my.id/apix/dtSo',{id},(e,d)=>{
                                            const dtSo = d.data[0];
                                            // console.log(dtSo);
                                            if (dtSo) {
                                                // cek tabel so_hst apakah ada data
                                                pR('https://cdn.weva.my.id/apix/dtSoHst',{id},(e2,d2)=>{
                                                    console.log("data so : ",dtSo);
                                                    console.log("data hst so : ",d2.data[0]);
                                                })
                                            }else{
                                                // ubah data di tabel main : kd_rak, kd_kol, qty_nett, id_hlp} dan insert tb_so
                                                console.log(dtSo);
                                                console.log("data so tidak ada, ubah data di tabel main");
                                            }
                                        })
                                    }
                                } else {
                                    span.text(oldVal); // Kembalikan ke value default jika tidak valid
                                }
                                span.data('editing', false);
                                span.show();
                                input.remove();
                            });
                        } else {
                            span.text(this.value);
                            span.data('editing', false);
                            span.show();
                            input.remove();
                        }
                    } else if (ev.key === 'Escape') {
                        span.data('editing', false);
                        span.show();
                        input.remove();
                    }
                })
                .on('blur', function() {
                    if (idx === 5) {
                        const inputVal = this.value;
                        // Validasi: hanya angka dan maksimal 2 digit desimal
                        if (/^\d+(\.\d{1,2})?$/.test(inputVal)) {
                            const newNett = parseFloat(inputVal).toFixed(2);
                            span.text(newNett);
                            // Hitung ulang kolom sst (idx 6) dan persentase (idx 7)
                            const row = span.closest('tr');
                            const tdSup = row.find('td').eq(4); // q_sup
                            const tdSst = row.find('td').eq(6); // sst
                            const tdPersen = row.find('td').eq(7); // %
                            const q_sup = parseFloat(tdSup.text()) || 0;
                            const q_nett = parseFloat(newNett) || 0;
                            const selisih = (q_nett > 0 && q_sup > 0) ? (q_nett - q_sup) : 0;
                            const persentase = (selisih !== 0 && q_sup > 0)
                                ? ((selisih / q_sup) * 100).toFixed(2) + '%'
                                : '0%';
                            // Update kolom sst dan %
                            tdSst.text(selisih.toFixed(2));
                            tdPersen.text(persentase);
                            // Warnai sesuai logic awal
                            tdSst.removeClass('text-red-600 text-blue-600');
                            if (selisih < 0) tdSst.addClass('text-red-600');
                            else if (selisih > 0) tdSst.addClass('text-blue-600');
                            tdPersen.removeClass('text-red-600 text-blue-600');
                            if (parseFloat(persentase) < 0) tdPersen.addClass('text-red-600');
                            else if (parseFloat(persentase) > 0) tdPersen.addClass('text-blue-600');
                            // Simpan ke dataInputRow
                            const id = row.find('td').eq(0).text();
                            window.dataInputRow = window.dataInputRow || {};
                            if (id) {
                                window.dataInputRow[id] = window.dataInputRow[id] || {};
                                window.dataInputRow[id].nett = newNett;
                            }
                            span.data('editing', false);
                            span.show();
                            input.remove();
                            // Optional: auto-advance ke kolom lokasi (col 8)
                            const tdLokasi = row.find('td').eq(8);
                            const spanLokasi = tdLokasi.find('span.edit-inline');
                            if (spanLokasi.length && !spanLokasi.data('editing')) {
                                spanLokasi.trigger('click');
                            }
                        } else {
                            span.text(oldVal); // Kembalikan ke value default jika tidak valid
                            span.data('editing', false);
                            span.show();
                            input.remove();
                        }
                    } else if (idx === 8) {
                        const inputVal = this.value;
                        const row = span.closest('tr');
                        const id = row.find('td').eq(0).text();
                        cekLokasiAsync(inputVal).then(hasil => {
                            if (hasil) {
                                span.text(hasil.loc);
                                // Simpan ke dataInputRow
                                window.dataInputRow = window.dataInputRow || {};
                                if (id) {
                                    window.dataInputRow[id] = window.dataInputRow[id] || {};
                                    window.dataInputRow[id].loc = hasil.loc;
                                    window.dataInputRow[id].kode_rak = hasil.kode.rak;
                                    window.dataInputRow[id].kode_kol = hasil.kode.kol;
                                }
                                span.data('editing', false);
                                span.show();
                                input.remove();
                                // Auto-advance to HELPER (col 9)
                                const tdHelper = span.closest('tr').find('td').eq(9);
                                const spanHelper = tdHelper.find('span.edit-inline');
                                if (spanHelper.length && !spanHelper.data('editing')) {
                                    spanHelper.trigger('click');
                                }
                            } else {
                                span.text(oldVal); // Kembalikan ke value default jika tidak valid
                                span.data('editing', false);
                                span.show();
                                input.remove();
                            }
                        });
                    } else if (idx === 9) {
                        const inputVal = this.value;
                        const row = span.closest('tr');
                        const id = row.find('td').eq(0).text();
                        cekHelperAsync(inputVal).then(hasil => {
                            if (hasil) {
                                span.text(hasil.hlp);
                                // Simpan ke dataInputRow
                                window.dataInputRow = window.dataInputRow || {};
                                if (id) {
                                    window.dataInputRow[id] = window.dataInputRow[id] || {};
                                    window.dataInputRow[id].hlp = hasil.hlp;
                                    window.dataInputRow[id].id_hlp = hasil.id_hlp;
                                }
                            } else {
                                span.text(oldVal); // Kembalikan ke value default jika tidak valid
                            }
                            span.data('editing', false);
                            span.show();
                            input.remove();
                        });
                    } else {
                        span.text(this.value);
                        span.data('editing', false);
                        span.show();
                        input.remove();
                    }
                });
            span.hide().after(input);
            input.focus().select();
        });

        // Tambahkan fungsi utilitas untuk update status tombol proses
        function updateBtnProsesState() {
            const btnProses = document.getElementById('btnProses');
            if (!btnProses) return;
            const enable = getSelectedDataKeys().jumlah > 0;
            btnProses.disabled = !enable;
            if (enable) {
                btnProses.classList.remove('opacity-50', 'cursor-not-allowed');
                btnProses.classList.add('cursor-pointer');
            } else {
                btnProses.classList.add('opacity-50', 'cursor-not-allowed');
                btnProses.classList.remove('cursor-pointer');
            }
        }

        $(()=>{
            const urlParams = new URLSearchParams(window.location.search);
            const tgl = urlParams.get('tgl');
            fbsSvc = new Fbs(db);
            if (!tgl) {
                // Remove all body content
                document.body.innerHTML = '';
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-xs flex flex-col items-center">
                        <h2 class="text-lg font-bold mb-4">Masukkan Tanggal</h2>
                        <input id="tglInput" type="date" class="border rounded px-3 py-2 mb-4 w-full" value="${new Date().toISOString().split('T')[0]}">
                        <button id="submitTgl" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">Lanjutkan</button>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('submitTgl').onclick = function() {
                    const tglVal = document.getElementById('tglInput').value;
                    if (tglVal) {
                        window.location.search = '?tgl=' + tglVal;
                    }
                };
                return;
            }
            // First load reference data, then get main data
            loadReferenceData(() => {
                getDataMainOnFbs(tgl);
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            const btnRenew = document.getElementById('btnRenew');
            if (btnRenew) btnRenew.onclick = function() {
                const urlParams = new URLSearchParams(window.location.search);
                const tgl = urlParams.get('tgl');
                if (!tgl) {
                    alert('Tanggal tidak ditemukan di URL!');
                    return;
                }
                if (!confirm('Perbaharui seluruh data pada tanggal ini dengan data terbaru? Data lama akan dihapus dan diganti!')) return;
                // Hapus semua data lama di path firebase
                fbsSvc.delDt(`/app/verif-data-masuk/${tgl}`, function() {
                    // Ambil data terbaru dari API
                    callDataMain(tgl, function(err, data) {
                        if (err) {
                            alert('Gagal mengambil data baru dari API!');
                            return;
                        }
                        if (!data || (Array.isArray(data) && data.length === 0) || (typeof data === 'object' && Object.keys(data).length === 0)) {
                            alert('Data tidak tersedia untuk tanggal tersebut!');
                            window.location.href = './';
                            return;
                        }
                        // Simpan data baru ke firebase
                        _.forEach(data, function(item) {
                            fbsSvc.iDtKy(`/app/verif-data-masuk/${tgl}`, item, function(){});
                        });
                        setTimeout(function() {
                            getDataMainOnFbs(tgl);
                        }, 1200);
                    });
                });
            };
            const btnProses = document.getElementById('btnProses');
            const modalProses = document.getElementById('modalProses');
            // --- Tambahan: Set default disabled pada tombol Proses Data ---
            if (btnProses) {
                btnProses.disabled = true;
                btnProses.classList.add('opacity-50', 'cursor-not-allowed');
                btnProses.classList.remove('cursor-pointer');
            }
            // ---
            if (btnProses) btnProses.onclick = () => {
                if (btnProses.disabled) return;
                modalProses.classList.remove('hidden');
                const idSelected = getSelectedDataMain().jumlah == 0 ? null : getSelectedDataMain().dataKeys.join(', ');
                $('#textAreaMenampungIdStock').val(idSelected);
                // console.log(idSelected);
                listenerModalProses();
            };
            if (modalProses) {
                document.getElementById('btnBatal').onclick = () => modalProses.classList.add('hidden');
                document.getElementById('btnProsesModal').onclick = () => { alert('Proses!'); modalProses.classList.add('hidden'); };
            }
            // Search
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    // Multi-keyword: lowercase, split by space
                    window._searchQuery = this.value.toLowerCase();
                    filterAndRenderTable();
                });
            }
            // Clear checked button
            const btnClearChecked = document.getElementById('btnClearChecked');
            if (btnClearChecked) {
                btnClearChecked.onclick = function() {
                    const tableBody = document.getElementById('dataTable');
                    if (tableBody) {
                        for (let row of tableBody.children) {
                            const idStock = row.children[0]?.textContent;
                            if (idStock) checkedRows[idStock] = false;
                            if (idStock) delete dataCHecked[idStock];
                        }
                    }
                    updateCheckedInfo();
                    filterAndRenderTable();
                    updateBtnProsesState();
                };
            }
            // Select all button
            const btnSelectAll = document.getElementById('btnSelectAll');
            if (btnSelectAll) {
                btnSelectAll.onclick = function() {
                    const tableBody = document.getElementById('dataTable');
                    if (tableBody) {
                        for (let row of tableBody.children) {
                            const idStock = row.children[0]?.textContent;
                            if (idStock) {
                                checkedRows[idStock] = true;
                                let item = null;
                                if (window._lastData && Array.isArray(window._lastData)) {
                                    item = window._lastData.find(d => d.id_stock == idStock);
                                }
                                if (item) {
                                    const lotRoll = (item.lot || '') + ' # ' + (item.rol || '');
                                    const kolRak = (getRakName(item.kd_rak) || '') + ' ' + (getKolName(item.kd_kol) || '');
                                    const selisih = (item.q_nett > 0 && item.q_sup > 0) ? (item.q_nett - item.q_sup) : 0;
                                    const persentase = (selisih !== 0 && item.q_sup > 0)
                                        ? ((selisih / item.q_sup) * 100).toFixed(2) + '%'
                                        : '0%';
                                    dataCHecked[idStock] = {
                                        id_stock: item.id_stock,
                                        no_po: item.no_po,
                                        id_kain: item.id_kain,
                                        kain: getKainName(item.id_kain),
                                        lot: item.lot,
                                        rol: item.rol,
                                        q_sup: item.q_sup,
                                        q_nett: item.q_nett,
                                        selisih: selisih,
                                        persentase: persentase,
                                        rak: (dataLocal.dataRak[item.kd_rak] && dataLocal.dataRak[item.kd_rak].v) || null,
                                        kol: (dataLocal.dataKol[item.kd_kol] && dataLocal.dataKol[item.kd_kol].v) || null,
                                        helper: (dataLocal.dataHelper[item.id_hlp] && dataLocal.dataHelper[item.id_hlp].hlp) || null,
                                        lotRoll: lotRoll,
                                        kolRak: kolRak
                                    };
                                }
                            }
                        }
                    }
                    updateCheckedInfo();
                    filterAndRenderTable();
                    updateBtnProsesState();
                };
            }

            $(document).on('click', '#dataTable td.hover\\:bg-gray-50', function() {
                setTimeout(function() {
                    updateBtnProsesState();
                }, 10);
            });
        });
    </script>
    </body>
</html>