<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Verifikasi Barang Masuk</title>
        <link rel="icon" href="https://cdn-icons-png.freepik.com/512/628/628300.png" />
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body>
        <div class="p-6 bg-gray-100 min-h-screen">
            <div class="mx-auto bg-white shadow-lg rounded-xl">
                <!-- Header Bar -->
                <div class="flex items-center justify-between px-4 py-2 border-b border-gray-200 bg-gray-50 sticky top-0 z-20">
                    <button id="btnRenew" class="bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-900">Renew Data</button>
                    <input id="searchInput" type="text" placeholder="Cari..." class="border rounded px-3 py-1 w-1/2 mx-4" />
                    <span id="dataCount" class="text-xs text-gray-600">0 of 0</span>
                    <div class="flex items-center gap-1">
                        <span id="checkedCount" class="text-xs text-blue-700">Checked: 0</span>
                        <button id="btnClearChecked" title="Clear Checked" class="text-xs text-gray-400 hover:text-red-500 focus:outline-none">&#10006;</button>
                        <button id="btnSelectAll" title="Select All" class="text-xs text-gray-400 hover:text-green-600 focus:outline-none ml-1">&#10003; All</button>
                    </div>
                    <button id="btnProses" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-800">Proses Data</button>
                </div>
                <div class="overflow-x-auto">
                    <div style="max-height:700px;overflow:auto;">
                        <table class="min-w-full divide-y divide-gray-200 border border-gray-400">
                            <thead class="bg-gray-900 text-white sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[60px] border border-gray-400">ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[60px] border border-gray-400">PO</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border border-gray-400">ID Kain</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[100px] border border-gray-400">LTRL</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[60px] border border-gray-400">SUP</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[60px] border border-gray-400">Nett</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[60px] border border-gray-400">SST</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[60px] border border-gray-400">%</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[100px] border border-gray-400">LOC</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider w-[100px] border border-gray-400">HLP</th>
                                </tr>
                            </thead>
                            <tbody id="dataTable" class="divide-y divide-gray-100 bg-white text-sm text-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal for Proses Data -->
        <div id="modalProses" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
            <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-xs flex flex-col items-center">
                <h2 class="text-lg font-bold mb-4">Hello World</h2>
                <div class="flex w-full gap-2">
                    <button id="btnBatal" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-800 w-1/2">Batal</button>
                    <button id="btnProsesModal" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-800 w-1/2">Proses</button>
                </div>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/diarmacpro/cdnku@4849b7e3a19e88b14d27454f60d16c062e16648d/core.js" integrity="sha256-xxU8WD/MI8uoZ1geRPVqbSvo6MuHLOUHfu/0Vg8Bewg=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/diarmacpro/cdnku@35e5003dbb8177b966f240b861c2bb547fc7f013/firebase-olah-data/f.o.d_v.0.2.js" integrity="sha256-5kpwc2PDnZf+BOBdrhIYWlFq4QlxajP7UhRJZtU3Wos=" crossorigin="anonymous"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, update, push, query, remove, orderByChild, equalTo, onValue, off } from 'https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js';

        const app = initializeApp({ databaseURL: "https://stock-wv-default-rtdb.asia-southeast1.firebasedatabase.app" });
        const db = getDatabase(app);
        Object.assign(window, { db, ref, set, get, update, push, query, remove, orderByChild, equalTo, onValue, off });
    </script>
    <script>
        var fbsSvc, dataMainOnFbs, dataLocal = {
            dataHelper: {},
            dataRak: {},
            dataKol: {}
        };
        var checkedRows = {};
        let totalData = 0;
        
        const dataCount = document.getElementById('dataCount');
        const checkedCount = document.getElementById('checkedCount');

        // Load reference data
        function loadReferenceData(callback) {
            let loadCount = 0;
            const checkComplete = () => {
                loadCount++;
                if (loadCount === 3) callback();
            };
            
            fbsSvc.gDt('/app/data/helper', '', (dataHelper) => {
                // Convert to id-based lookup object
                dataLocal.dataHelper = _.reduce(dataHelper, (result, value) => {
                    result[value.id_hlp] = value;
                    return result;
                }, {});
                checkComplete();
            });

            fbsSvc.gDt('/app/data/rak', '', (dataRak) => {
                // Build lookup by i for display
                dataLocal.dataRak = _.reduce(dataRak, function(result, value) {
                    result[value.i] = value;
                    return result;
                }, {});
                checkComplete();
            });

            fbsSvc.gDt('/app/data/kol', '', (dataKol) => {
                // Build lookup by i for display
                dataLocal.dataKol = _.reduce(dataKol, function(result, value) {
                    result[value.i] = value;
                    return result;
                }, {});
                checkComplete();
            });

            fbsSvc.gDt('/app/data/kain', '', (dataKain) => {
                dataLocal.dataKain = dataKain; // keep as array
                // Build lookup for rendering
                dataLocal._kainLookup = _.reduce(dataKain, function(result, value) {
                    result[value.id_kain] = value;
                    return result;
                }, {});
                checkComplete();
            });
        }

        function getHelperName(id) {
            return _.get(dataLocal.dataHelper, [id, 'hlp'], id);
        }

        function getRakName(id) {
            return (dataLocal.dataRak && dataLocal.dataRak[id]) ? dataLocal.dataRak[id].v : id;
        }

        function getKolName(id) {
            return (dataLocal.dataKol && dataLocal.dataKol[id]) ? dataLocal.dataKol[id].v : id;
        }

        function getKainName(id) {
            return (dataLocal._kainLookup && dataLocal._kainLookup[id]) ? dataLocal._kainLookup[id].k : id;
        }

        function properText(text) {
        return text
            .toLowerCase()
            .replace(/\b\w/g, char => char.toUpperCase());
        }
        
        function renderTableData(data) {
            window._lastData = data;
            let filtered = data;
            console.log("xxx",filtered)
            console.log("xxx",filtered.length)
            let isSearchActive = window._searchQuery && window._searchQuery.length > 0;
            if (isSearchActive) {
                // Multi-keyword, order-insensitive search
                const keywords = window._searchQuery.split(/\s+/).filter(Boolean);
                filtered = _.filter(data, function(item) {
                    const searchStr = [
                        getKainName(item.id_kain),
                        item.id_stock,
                        item.no_po,
                        item.lot,
                        item.rol,
                        getRakName(item.kd_rak),
                        getKolName(item.kd_kol),
                        getHelperName(item.id_hlp)
                    ].join(' ').toLowerCase();
                    return keywords.every(kw => searchStr.includes(kw));
                });
            }
            // Update data count and checked count
            if (window.dataMainOnFbs && typeof window.dataMainOnFbs === 'object') {
                totalData = Object.keys(window.dataMainOnFbs).length;
            }
            if (dataCount) {
                console.log(filtered.length);
                dataCount.textContent = `${typeof filtered.length === 'undefined' ? totalData : (filtered.length === 0 ? 0 : filtered.length)} of ${totalData}`;
            }
            if (checkedCount) {
                const checked = Object.values(checkedRows).filter(Boolean).length;
                checkedCount.textContent = `Checked: ${checked}`;
            }
            const tableBody = document.getElementById('dataTable');
            tableBody.innerHTML = '';
            _.forEach(filtered, (item) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition cursor-pointer';
                // Row check logic
                row.onclick = function() {
                    checkedRows[item.id_stock] = !checkedRows[item.id_stock];
                    this.classList.toggle('bg-blue-100', checkedRows[item.id_stock]);
                    this.classList.toggle('font-bold', checkedRows[item.id_stock]);
                    updateCheckedInfo();
                };
                if (checkedRows[item.id_stock]) {
                    row.classList.add('bg-blue-100', 'font-bold');
                }
                // Compose Kol Rak and Lot#Roll
                const lotRoll = (item.lot || '') + ' # ' + (item.rol || '');
                const kolRak = (getRakName(item.kd_rak) || '') + ' ' + (getKolName(item.kd_kol) || '');
                // Render columns in new order
                const selisih = (item.q_nett > 0 && item.q_sup > 0) ? (item.q_nett - item.q_sup) : 0;
                const persentase = (selisih !== 0 && item.q_sup > 0)
                ? ((selisih / item.q_sup) * 100).toFixed(2) + '%'
                : '0%';

                const columns = [
                item.id_stock || '',
                item.no_po || '',
                properText( getKainName( item.id_kain ) ),
                lotRoll,
                item.q_sup || '0.00',
                item.q_nett || '0.00',
                selisih.toFixed(2),     // kolom selisih
                persentase,             // kolom persentase
                kolRak,
                getHelperName(item.id_hlp)
                ];
                columns.forEach((val, idx) => {
                    const cell = document.createElement('td');
                    cell.className = 'px-4 py-1 border border-gray-400';
                    // q_nett (idx 5) and selisih/sst (idx 6)
                    if (idx === 5 || idx === 6) {
                        const num = parseFloat(val);
                        if (num < 0) cell.classList.add('text-red-600');
                        else if (num > 0) cell.classList.add('text-blue-600');
                    }
                    cell.textContent = val;
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });
            updateCheckedInfo();
        }

        function filterAndRenderTable() {
            // Always filter from the original data
            const data = window._dataMainOnFbs || [];
            let filtered = data;
            if (window._searchQuery && window._searchQuery.length > 0) {
                const keywords = window._searchQuery.split(/\s+/).filter(Boolean);
                filtered = _.filter(data, function(item) {
                    const searchStr = [
                        getKainName(item.id_kain),
                        item.id_stock,
                        item.no_po,
                        item.lot,
                        item.rol,
                        getRakName(item.kd_rak),
                        getKolName(item.kd_kol),
                        getHelperName(item.id_hlp)
                    ].join(' ').toLowerCase();
                    return keywords.every(kw => searchStr.includes(kw));
                });
            }
            renderTableData(filtered);
        }

        function updateCheckedInfo() {
            // Show checked count in checkedCount span
            const checkedCount = document.getElementById('checkedCount');
            if (checkedCount) {
                const checked = Object.values(checkedRows).filter(Boolean).length;
                checkedCount.textContent = `Checked: ${checked}`;
            }
        }

        function callData(url, payload, callback) {
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (typeof callback === 'function') {
                    callback(null, data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (typeof callback === 'function') {
                    callback(error, null);
                }
            });
        }

        function callDataMain(tgl, callback) {
            callData('https://cdn.weva.my.id/apix/dtMn', { tgl }, callback);
        }

        function generateDataMainOnFbs(tgl){
            callDataMain(tgl,(err_data,data)=>{
                if (err_data) {
                    console.error(err_data);
                } else if (!data || (Array.isArray(data) && data.length === 0) || (typeof data === 'object' && Object.keys(data).length === 0)) {
                    alert('Data tidak tersedia untuk tanggal tersebut!');
                    window.location.href = './';
                } else {
                    _.map(data,(v,k)=>{
                        fbsSvc.iDtKy(`/app/verif-data-masuk/${tgl}`,v,()=>{});
                    })
                }
            })
        }

        function checkAndFixDuplicates(tgl, callback) {
            // Ambil data dari Firebase
            fbsSvc.gDt(`/app/verif-data-masuk/${tgl}`, '', (data) => {
                if (!data || _.isEmpty(data)) {
                    if (typeof callback === 'function') callback();
                    return;
                }
                // Deteksi duplikat berdasarkan id_stock
                const countById = _.countBy(data, 'id_stock');
                const hasDuplicate = Object.values(countById).some(cnt => cnt > 1);
                if (!hasDuplicate) {
                    if (typeof callback === 'function') callback();
                    return;
                }
                // Jika ada duplikat, hapus semua data di path utama
                fbsSvc.delDt(`/app/verif-data-masuk/${tgl}`, '', () => {
                    // Fetch data baru dari API
                    callDataMain(tgl, (err, newData) => {
                        if (!err && newData) {
                            _.map(newData, (v) => {
                                fbsSvc.iDtKy(`/app/verif-data-masuk/${tgl}`, v, () => {});
                            });
                            // Tunggu sebentar lalu callback
                            setTimeout(() => {
                                if (typeof callback === 'function') callback();
                            }, 1200);
                        } else {
                            if (typeof callback === 'function') callback();
                        }
                    });
                });
            });
        }

        function getDataMainOnFbs(tgl){
            checkAndFixDuplicates(tgl, () => {
                fbsSvc.gDt(`/app/verif-data-masuk/${tgl}`, '', (data) => {
                    dataMainOnFbs = data;
                    window._dataMainOnFbs = data; // Save original data for filtering
                    // If data is empty or null, generate and reload
                    if (!data || _.isEmpty(data)) {
                        generateDataMainOnFbs(tgl);
                        // After generate, reload data (with delay to ensure write completes)
                        setTimeout(() => getDataMainOnFbs(tgl), 1200);
                    } else {
                        filterAndRenderTable();
                    }
                });
            });
        }

        $(()=>{
            const urlParams = new URLSearchParams(window.location.search);
            const tgl = urlParams.get('tgl');
            fbsSvc = new Fbs(db);
            if (!tgl) {
                // Remove all body content
                document.body.innerHTML = '';
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-xs flex flex-col items-center">
                        <h2 class="text-lg font-bold mb-4">Masukkan Tanggal</h2>
                        <input id="tglInput" type="date" class="border rounded px-3 py-2 mb-4 w-full" value="${new Date().toISOString().split('T')[0]}">
                        <button id="submitTgl" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">Lanjutkan</button>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('submitTgl').onclick = function() {
                    const tglVal = document.getElementById('tglInput').value;
                    if (tglVal) {
                        window.location.search = '?tgl=' + tglVal;
                    }
                };
                return;
            }
            // First load reference data, then get main data
            loadReferenceData(() => {
                getDataMainOnFbs(tgl);
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            const btnRenew = document.getElementById('btnRenew');
            if (btnRenew) btnRenew.onclick = () => console.log('renew');
            const btnProses = document.getElementById('btnProses');
            const modalProses = document.getElementById('modalProses');
            if (btnProses) btnProses.onclick = () => { modalProses.classList.remove('hidden'); };
            if (modalProses) {
                document.getElementById('btnBatal').onclick = () => modalProses.classList.add('hidden');
                document.getElementById('btnProsesModal').onclick = () => { alert('Proses!'); modalProses.classList.add('hidden'); };
            }
            // Search
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    // Multi-keyword: lowercase, split by space
                    window._searchQuery = this.value.toLowerCase();
                    filterAndRenderTable();
                });
            }
            // Clear checked button
            const btnClearChecked = document.getElementById('btnClearChecked');
            if (btnClearChecked) {
                btnClearChecked.onclick = function() {
                    // Uncheck hanya data yang sedang terlihat/disajikan di tabel
                    const tableBody = document.getElementById('dataTable');
                    if (tableBody) {
                        for (let row of tableBody.children) {
                            const idStock = row.children[0]?.textContent;
                            if (idStock) checkedRows[idStock] = false;
                        }
                    }
                    updateCheckedInfo();
                    filterAndRenderTable();
                };
            }
            // Select all button
            const btnSelectAll = document.getElementById('btnSelectAll');
            if (btnSelectAll) {
                btnSelectAll.onclick = function() {
                    // Ambil data yang sedang ditampilkan di tabel (hasil filter/pencarian atau render awal)
                    let filtered = [];
                    const tableBody = document.getElementById('dataTable');
                    if (tableBody) {
                        // Ambil semua id_stock dari baris yang sedang tampil
                        for (let row of tableBody.children) {
                            // Ambil id_stock dari kolom pertama (pastikan urutan kolom benar)
                            const idStock = row.children[0]?.textContent;
                            if (idStock) checkedRows[idStock] = true;
                        }
                    }
                    updateCheckedInfo();
                    filterAndRenderTable();
                };
            }
        });
    </script>
    </body>
</html>