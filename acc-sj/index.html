<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Proses WH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"/>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div class="flex h-screen">
        <aside class="w-96 bg-white shadow-lg p-4 flex flex-col overflow-y-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Daftar SJ</h2>
            <div id="loadingMessage" class="text-center text-gray-500 mb-4">
                Memuat data...
            </div>
            <div id="noDataMessage" class="text-center text-gray-500 hidden mb-4">
                Tidak ada data yang ditemukan.
            </div>
            <div id="summaryList" class="space-y-2">
                </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto">
            <div class="bg-white shadow-md rounded-lg p-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Detail Surat Jalan</h1>
                <div id="detailContent" class="text-gray-600">
                    <p>Silakan pilih salah satu Surat Jalan dari daftar di sidebar untuk melihat detailnya.</p>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.10.0/dist/axios.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/diarmacpro/cdnku@4849b7e3a19e88b14d27454f60d16c062e16648d/core.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/diarmacpro/cdnku@35e5003dbb8177b966f240b861c2bb547fc7f013/firebase-olah-data/f.o.d_v.0.2.js" crossorigin="anonymous"></script>
    <script src="./script.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getDatabase, ref, set, get, update, push, query, remove, orderByChild, equalTo, onValue, off } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js';
        const app0 = initializeApp({ databaseURL: 'https://stock-wv-default-rtdb.asia-southeast1.firebasedatabase.app'}, 'app0');
        const db0 = getDatabase(app0);

        const app1 = initializeApp( { databaseURL: 'https://main-stock-wv-default-rtdb.asia-southeast1.firebasedatabase.app' }, 'app1' );
        const db1 = getDatabase(app1);

        const app2 = initializeApp( { databaseURL: 'https://stk-wv-default-rtdb.asia-southeast1.firebasedatabase.app' }, 'app2' );
        const db2 = getDatabase(app2);

        Object.assign(window, { db0, db1, db2, ref, set, get, update, push, query, remove, orderByChild, equalTo, onValue, off });
    </script>
    <script>
        let fbsSvc0, fbsSvc1, fbsSvc2;
        let allSjData = {}; // Variabel untuk menyimpan semua data SJ

        $(() => {
            fbsSvc0 = new Fbs(db0);
            fbsSvc1 = new Fbs(db1);
            fbsSvc2 = new Fbs(db2);

            function groupBy(arr, key) {
                return arr.reduce((acc, obj) => {
                    const value = obj[key];
                    (acc[value] = acc[value] || []).push(obj);
                    return acc;
                }, {});
            }

            function renderSummaryList(data) {
                const summaryList = document.getElementById('summaryList');
                const loadingMessage = document.getElementById('loadingMessage');
                const noDataMessage = document.getElementById('noDataMessage');

                loadingMessage.classList.add('hidden');
                
                if (data.length === 0) {
                    noDataMessage.classList.remove('hidden');
                    return;
                }

                noDataMessage.classList.add('hidden');
                summaryList.innerHTML = '';
                
                data.forEach(item => {
                    const listItem = document.createElement('div');
                    listItem.classList.add('cursor-pointer', 'p-3', 'rounded-lg', 'bg-gray-100', 'hover:bg-blue-100', 'transition', 'duration-200', 'flex', 'items-center', 'space-x-4');
                    listItem.innerHTML = `
                        <div class="w-12 text-sm text-gray-500">${item.stamp_sj_min || '-'}</div>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800">${item.id_sj}</div>
                            <div class="text-xs text-gray-500">${item.mkt_name || '-'}</div>
                        </div>
                        <div class="w-12 text-xs text-gray-400 font-bold text-right">${item.count} item</div>
                    `;
                    listItem.onclick = () => showDetail(item.id_sj);
                    summaryList.appendChild(listItem);
                });
            }

            window.showDetail = function(idSj) {
                console.log(`Fungsi showDetail dipanggil untuk ID SJ: ${idSj}`);
                
                const detailContent = document.getElementById('detailContent');
                const selectedSj = allSjData[idSj];

                if (selectedSj && selectedSj.length > 0) {
                    const firstItem = selectedSj[0];
                    const detailsHtml = `
                        <h2 class="text-2xl font-semibold mb-2">${idSj}</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <p class="text-sm text-gray-500">Marketing</p>
                                <p class="text-lg font-bold text-gray-800">${firstItem.mkt_name || '-'}</p>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <p class="text-sm text-gray-500">Waktu Awal</p>
                                <p class="text-lg font-bold text-gray-800">${firstItem.stamp_sj_min || '-'}</p>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <p class="text-sm text-gray-500">Total Item</p>
                                <p class="text-lg font-bold text-gray-800">${selectedSj.length}</p>
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-semibold mt-4 mb-2 border-t pt-4">Daftar Item</h3>
                        <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-200">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${selectedSj.map(item => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.sku || '-'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.qty || '-'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.lokasi || '-'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.ket || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    detailContent.innerHTML = detailsHtml;
                    console.log("Detail Data:", selectedSj);
                } else {
                    detailContent.innerHTML = `<p class="text-red-500">Detail untuk SJ ${idSj} tidak ditemukan.</p>`;
                }
            };

            function fetchAndRender() {
                let userMap = {};
                
                fbsSvc2.gDt('user', '', (userData) => {
                    for (const key in userData) {
                        if (Object.hasOwnProperty.call(userData, key)) {
                            const user = userData[key];
                            userMap[user.id_mkt] = user.mkt;
                        }
                    }

                    postToAPI('https://app.weva.my.id/api/data-sj-awal', { id_sj: true }, (d) => {
                        if (!d || !d.data || d.data.length === 0) {
                            console.log('Tidak ada data yang ditemukan.');
                            renderSummaryList([]);
                            return;
                        }

                        const groupedData = groupBy(d.data, 'id_sj');
                        const summaryData = {};
                        
                        allSjData = {};
                        
                        for (const idSj in groupedData) {
                            if (Object.hasOwnProperty.call(groupedData, idSj)) {
                                const items = groupedData[idSj];
                                const count = items.length;
                                const firstIdMkt = items[0].id_mkt;
                                
                                let minTimestamp = null;
                                items.forEach(item => {
                                    const itemFullTime = item.stamp_sj.split(' ')[1];
                                    if (!minTimestamp || itemFullTime < minTimestamp) {
                                        minTimestamp = itemFullTime;
                                    }
                                    item.mkt_name = userMap[item.id_mkt] || item.id_mkt;
                                });

                                const formattedTime = minTimestamp ? minTimestamp.substring(0, 5) : null;
                                const mktName = userMap[firstIdMkt] || firstIdMkt;

                                allSjData[idSj] = items;
                                
                                summaryData[idSj] = {
                                    id_sj: idSj,
                                    count: count,
                                    mkt_name: mktName,
                                    stamp_sj_min: formattedTime
                                };
                            }
                        }

                        const summaryArray = Object.values(summaryData);

                        summaryArray.sort((a, b) => {
                            if (a.stamp_sj_min < b.stamp_sj_min) return -1;
                            if (a.stamp_sj_min > b.stamp_sj_min) return 1;
                            return 0;
                        });

                        renderSummaryList(summaryArray);
                        
                    }, (error) => {
                        console.error('Error saat mengambil data SJ:', error);
                        document.getElementById('loadingMessage').classList.add('hidden');
                        alert('Gagal mengambil data dari API.');
                    });
                }, (error) => {
                    console.error('Error saat mengambil data user:', error);
                    document.getElementById('loadingMessage').classList.add('hidden');
                    alert('Gagal mengambil data user.');
                });
            }

            fetchAndRender();
        });
    </script>
</body>
</html>